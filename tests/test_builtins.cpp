#include <iostream>
#include <string.h>

constexpr size_t N{1024 * 4};
constexpr size_t M{1024 * 4};
int m[N][M];

bool testPrefetch1(int seed)
{
    for (size_t i = 0 ; i < N ; ++i)
    {
        for (size_t j = 0 ; j < M ; ++j)
        {
            m[i][j] = i * j;
        }
    }
    //std::cout << "finsihed testPrefetch1" << std::endl;
    if (m[12][4] == seed)
    {
        return false;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
    }
    return true;
}

bool testPrefetch2(int seed)
{
    for (size_t i = 0 ; i < N ; ++i)
    {
        for (size_t j = 0 ; j < M ; ++j)
        {
            m[j][i] = i * j;

            //__builtin_prefetch(&m[j+1][i], 1 /* write and read */, 0 /* used once */);
        }
        //const auto jLast{M - 1};
        //m[jLast][i] = i * jLast;
    }
    //std::cout << "finsihed testPrefetch2" << std::endl;
    if (m[12][4] == seed)
    {
        return false;
    }
    return true;
}

int main(int argc, char* argv[])
{
    if (argc == 2)
    {
        if (strcmp(argv[1], "1") == 0)
        {
            if (!testPrefetch1(argc))
	    	    return __LINE__;
        }
        if (strcmp(argv[1], "2") == 0)
        {
            if (!testPrefetch2(argc))
	    	    return __LINE__;
        }
    }
    else
    {
        if (!testPrefetch1(argc))
	    	return __LINE__;
        if (!testPrefetch2(argc))
	    	return __LINE__;
    }

	return 0;
}
